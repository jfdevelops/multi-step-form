#!/bin/sh

echo "ğŸ” Checking for relevant file changes..."

# Get list of staged files
staged_files=$(git diff --cached --name-only)

if [ -z "$staged_files" ]; then
  echo "Empty commit or no file changes detected."
  # We can exit successfully here or let it continue to build checks if you prefer
  # usually safe to continue, or exit 0.
fi

# Define patterns as a single Regex string (no arrays!)
test_relevant_patterns="\.(js|jsx|ts|tsx|json)$|package(-lock)?\.json$|yarn\.lock$|pnpm-lock\.yaml$|\.(test|spec)\.|__tests__|src/|lib/|components/"

# Check if any staged files match our patterns
if echo "$staged_files" | grep -E -q "$test_relevant_patterns"; then
  echo "ğŸ§ª Running tests before commit..."
  pnpm run test:packages --browser.headless=true

  if [ $? -ne 0 ]; then
    echo "âŒ Tests failed - aborting commit."
    exit 1
  fi
else
  echo "â­ï¸  No test-relevant files changed - skipping tests"
fi

echo "ğŸ“¦ Building packages..."
pnpm run build:packages

if [ $? -ne 0 ]; then
  echo "âŒ Build failed - aborting commit."
  exit 1
fi

echo "âœ… Tests and build succeeded - proceeding with commit."
